name: CI

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Install dotnet-coverage
      run: dotnet tool install --global dotnet-coverage
      
    - name: Build
      run: dotnet build --configuration Release --no-restore
      
    - name: Run tests with coverage
      run: dotnet-coverage collect "dotnet test --configuration Release --no-build --verbosity normal" -f xml -o coverage.xml
      
    - name: List coverage files (debug)
      if: matrix.os == 'ubuntu-latest'
      run: |
        echo "Searching for coverage files..."
        ls -la *.xml || echo "No XML files found"
        cat coverage.xml | head -20 || echo "Cannot read coverage.xml"
      
    - name: Upload coverage reports to Codecov
      if: matrix.os == 'ubuntu-latest'
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage.xml
        flags: unittests
        fail_ci_if_error: false
        verbose: true

  build:
    name: Build Release Artifacts
    runs-on: windows-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Publish Windows x64
      run: dotnet publish -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -p:DebugType=None -p:DebugSymbols=false -o ./artifacts/win-x64
      
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: filecombiner-win-x64
        path: ./artifacts/win-x64/filecombiner.exe
        retention-days: 30
